<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 12px; margin-bottom: 15px;">
        <h2 style="border: none; margin: 0; padding: 0; margin-bottom: 0;">ðŸŒ™ Midnight Jobs</h2>
        <button id="btn-run-batch" onclick="triggerMidnightBatch()" style="padding: 4px 12px; background: #1e1e1e; color: #03dac6; border: 1px solid #03dac6; border-radius: 4px; cursor: pointer; font-size: 0.75rem; font-weight: bold; transition: all 0.2s;">
            â–¶ Run Now
        </button>
    </div>
    
    <div id="jobs-container" style="display: flex; flex-direction: column; gap: 10px;">
        <div style="text-align: center; color: #666;">Loading job status...</div>
    </div>
    
    <div style="margin-top: 15px; text-align: right;">
        <small style="color: #666;" id="jobs-last-updated">Updated: --</small>
    </div>
</div>

<script>
    async function loadJobs() {
        try {
            const response = await fetch('/api/jobs/latest');
            const jobs = await response.json();
            const container = document.getElementById('jobs-container');
            
            if (jobs.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #888;">No job history found.</div>';
                return;
            }

            container.innerHTML = ''; // Clear loading

            jobs.forEach(job => {
                const row = document.createElement('div');
                row.style.display = 'flex';
                row.style.justifyContent = 'space-between';
                row.style.alignItems = 'center';
                row.style.borderBottom = '1px solid #333';
                row.style.paddingBottom = '5px';

                let badgeClass = 'badge';
                if (job.status === 'SUCCESS') badgeClass += ' active';
                else if (job.status === 'FAILURE') badgeClass += ' expired';
                else if (job.status === 'WARNING') badgeClass += ' warning';
                else badgeClass += ' warning'; // RUNNING or others

                row.innerHTML = `
                    <div>
                        <div style="font-weight: 500;">${job.name}</div>
                        <div style="font-size: 0.8rem; color: #888;">${job.start || '-'}</div>
                    </div>
                    <div style="text-align: right;">
                        <span class="${badgeClass}">${job.status}</span>
                        <div style="font-size: 0.8rem; color: #888; margin-top: 2px;">${job.duration}</div>
                    </div>
                `;
                container.appendChild(row);
            });
            
            document.getElementById('jobs-last-updated').innerText = 'Updated: ' + new Date().toLocaleTimeString();

        } catch (error) {
            console.error('Failed to load jobs:', error);
            document.getElementById('jobs-container').innerHTML = '<div style="color: #ef5350;">Failed to load status</div>';
        }
    }

    async function triggerMidnightBatch() {
        if(!confirm("Are you sure you want to manually trigger the Midnight Jobs Batch?")) return;

        const btn = document.getElementById('btn-run-batch');
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = "Starting...";

        try {
            const response = await fetch('/api/jobs/trigger/midnight', { method: 'POST' });
            const result = await response.json();
            
            if (response.ok) {
                alert("Batch Started: " + result.message);
                loadJobs(); // Refresh immediately
            } else {
                alert("Error: " + result.message);
            }
        } catch (error) {
            alert("Request Failed: " + error);
        } finally {
            btn.disabled = false;
            btn.innerText = originalText;
        }
    }

    // Load immediately and then refresh every 30s
    loadJobs();
    setInterval(loadJobs, 30000);
</script>
